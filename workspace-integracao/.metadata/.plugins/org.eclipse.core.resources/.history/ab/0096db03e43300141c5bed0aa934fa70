package com.fiap.contamedica.gateway;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueConnectionFactory;
import javax.jms.QueueReceiver;
import javax.jms.QueueSender;
import javax.jms.QueueSession;
import javax.jms.Session;
import javax.jms.TextMessage;
import javax.naming.Context;
import javax.naming.NamingException;

import com.fiap.contamedica.business.AnaliseContaBusiness;

public class AnaliseMedicaConsumerGateway extends QueueBase {

	public AnaliseMedicaConsumerGateway() {
		analiseContaBusiness = new AnaliseContaBusiness();
	}

	private static final String NOME_FILA = "queue/FilaFIAP";
	private Context jndiContext;
	private QueueConnectionFactory queueConnectionFactory;
	private QueueConnection queueConnection;
	private QueueSession queueSession;
	private Queue queue;
	private QueueReceiver queueReceiver;
	private TextMessage message;
	private QueueSender replySender;
	private AnaliseContaBusiness analiseContaBusiness;
	
	public static void main(String[] args) {
		AnaliseMedicaConsumerGateway analiseMedicaConsumerGateway = new AnaliseMedicaConsumerGateway();
		analiseMedicaConsumerGateway.consumirXml();
	}
	
	public void consumirXml() {
		try {
			jndiContext = getInitial();
			queueConnectionFactory = (QueueConnectionFactory) jndiContext.lookup("ConnectionFactory");
			queue = (Queue) jndiContext.lookup(NOME_FILA);
			queueConnection = queueConnectionFactory.createQueueConnection();
			queueSession = queueConnection.createQueueSession(false,
					Session.AUTO_ACKNOWLEDGE);
			queueReceiver = queueSession.createReceiver(queue);
			queueConnection.start();
			while (true) {
				
				// Aguarda a mensagem por tempo indeterminado
				Message messageReceiver = queueReceiver.receive();
				if (messageReceiver != null) {
					if (messageReceiver instanceof TextMessage) {
						message = (TextMessage) messageReceiver;
						analiseContaBusiness.analisarConta(message.getText());
						
						/*
						 * Enviando a resposta
						 */
						Queue tempQueue = (Queue) message.getJMSReplyTo();

						// Cria um objeto sender para a fila de resposta
						replySender = queueSession.createSender(tempQueue);

						TextMessage resposta = queueSession.createTextMessage();
						resposta.setJMSCorrelationID(message.getJMSMessageID());

						replySender.send(resposta);
					} else {
						break;
					}
				}
			}
		} catch (JMSException e) {
			
		} catch (NamingException e) {
		} catch (Exception e) {
		} finally {
			fecharConexao(queueConnection);
		}
	}
}
