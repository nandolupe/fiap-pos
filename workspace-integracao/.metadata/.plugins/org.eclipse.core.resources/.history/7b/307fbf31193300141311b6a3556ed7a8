package com.fiap.contamedica.gateway;

import java.util.Properties;

import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.Queue;
import javax.jms.QueueConnection;
import javax.jms.QueueConnectionFactory;
import javax.jms.QueueReceiver;
import javax.jms.QueueSender;
import javax.jms.QueueSession;
import javax.jms.Session;
import javax.jms.TextMessage;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;

public class AnaliseMedicaConsumerGateway extends QueueBase {

	public AnaliseMedicaConsumerGateway() {
	}

	private static final String NOME_FILA = "queue/FilaFIAP";
	private Context jndiContext;
	private QueueConnectionFactory queueConnectionFactory;
	private QueueConnection queueConnection;
	private QueueSession queueSession;
	private Queue queue;
	private QueueReceiver queueReceiver;
	private TextMessage message;
	private QueueSender replySender;

	public void consumirXml() {
		try {
			jndiContext = getInitial();
			queueConnectionFactory = (QueueConnectionFactory) jndiContext.lookup("ConnectionFactory");
			queue = (Queue) jndiContext.lookup(NOME_FILA);
			queueConnection = queueConnectionFactory.createQueueConnection();
			System.out.println("*** Criando conexão com Queue...");
			queueSession = queueConnection.createQueueSession(false,
					Session.AUTO_ACKNOWLEDGE);
			System.out.println("*** Criando o Receiver");
			queueReceiver = queueSession.createReceiver(queue);
			System.out.println("*** Iniciando a conexão...");
			queueConnection.start();
			while (true) {
				
				// Aguarda a mensagem por tempo indeterminado
				Message messageReceiver = queueReceiver.receive();
				if (messageReceiver != null) {
					if (messageReceiver instanceof TextMessage) {
						message = (TextMessage) messageReceiver;
						/*
						 * Enviando a resposta
						 */
						Queue tempQueue = (Queue) message.getJMSReplyTo();

						// Cria um objeto sender para a fila de resposta
						replySender = queueSession.createSender(tempQueue);

						TextMessage resposta = queueSession.createTextMessage();
						resposta.setJMSCorrelationID(message.getJMSMessageID());

						replySender.send(resposta);

					} else {
						break;
					}
				}
			}
		} catch (JMSException e) {
		} catch (NamingException e) {
		} catch (Exception e) {
		} finally {
			fecharConexao(queueConnection);
		}
	}

	private static InitialContext getInitial() throws Exception {
		Properties props = new Properties();
		props.setProperty("java.naming.factory.initial",
				"org.jnp.interfaces.NamingContextFactory");
		props.setProperty("java.naming.provider.url", "localhost:1099");
		props.setProperty("java.naming.factory.url.pkgs", "org.jboss.naming");
		InitialContext context = new InitialContext(props);
		return context;
	}
}
